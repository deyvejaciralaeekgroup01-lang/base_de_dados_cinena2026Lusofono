
package control;

import BDConnection.CrudActorDirectorDAO;
import javax.swing.*;
import javax.swing.table.DefaultTableCellRenderer;
import javax.swing.table.DefaultTableModel;
import javax.swing.table.TableColumn;
import javax.swing.table.TableRowSorter;
import java.awt.*;
import java.sql.SQLException;
import java.util.Arrays;
import java.util.Objects;
import java.util.regex.Pattern;

public class JTableFilmes {

    private DefaultTableModel model;
    JPanel panel;
    private CrudActorDirectorDAO cruDirAc;
    private boolean isActorGlobal;
    private String btnText;
    private int idUpdate;
    JButton btnAdd;

    // Filtro no topo
    private JTextField tfFilter;

    // === CAMPOS DO FORMULÁRIO (rodapé) ===
    private JTextField tfNomeInput;          // <--- era local; agora é campo da classe
    private JComboBox<String> cbSexo;        // já existia como campo

    public JTableFilmes() throws SQLException {
        panel = new JPanel(new BorderLayout(8, 8));
        panel.setBorder(BorderFactory.createEmptyBorder(8, 8, 8, 8));
        panel.setBackground(new Color(245, 245, 245));
        tfFilter = new JTextField("");
        cruDirAc = new CrudActorDirectorDAO();
        btnText = "Adicionar";
    }

    public JPanel jtableGeneral(Object[][] dados, String[] cols, JPanel inputs, boolean isActor, String labelText) {
        // --- Garantir que "Actions" exista nas colunas ---
        String[] colsFinal = ensureActionsColumn(cols);
        isActorGlobal = isActor;

        // --- Garantir que "Actions" tenha uma célula adicional em cada linha dos dados ---
        Object[][] dadosFinal = ensureActionsData(dados, colsFinal);

        // Cria a tabela e garante que 'model' seja o do JTable
        JTable table = tabela(dadosFinal, colsFinal);
        this.model = (DefaultTableModel) table.getModel();

        if (Arrays.asList(colsFinal).contains("internalCode")) {
            hideColumnByName(table, "created_at");
        }

        // RowSorter + filtro
        final TableRowSorter<DefaultTableModel> sorter = new TableRowSorter<>(model);
        table.setRowSorter(sorter);

        // ====== TOPO: campo de filtro + botão "Limpar filtro" ======
        JPanel header = new JPanel();
        header.setLayout(new BoxLayout(header, BoxLayout.Y_AXIS));
        header.setOpaque(false);

        JPanel filterPanel = new JPanel(new FlowLayout(FlowLayout.LEFT, 6, 6));
        filterPanel.setOpaque(false);
        filterPanel.add(new JLabel("Filtro:"));

        final JTextField tfFilterLocal = new JTextField(25);
        JButton btnClearFilter = new JButton("Limpar filtro");
        filterPanel.add(tfFilterLocal);
        filterPanel.add(btnClearFilter);

        tfFilterLocal.getDocument().addDocumentListener(new javax.swing.event.DocumentListener() {
            private void apply() {
                String text = tfFilterLocal.getText();
                if (text == null || text.trim().isEmpty()) {
                    sorter.setRowFilter(null);
                } else {
                    sorter.setRowFilter(RowFilter.regexFilter("(?i)" + Pattern.quote(text)));
                }
            }
            public void insertUpdate(javax.swing.event.DocumentEvent e) { apply(); }
            public void removeUpdate(javax.swing.event.DocumentEvent e) { apply(); }
            public void changedUpdate(javax.swing.event.DocumentEvent e) { apply(); }
        });

        btnClearFilter.addActionListener(e -> {
            tfFilterLocal.setText("");
            sorter.setRowFilter(null);
        });

        header.add(filterPanel);
        panel.add(header, BorderLayout.NORTH);

        // ====== Hover effect (pula a coluna "Actions") ======
        final int[] hoverRow = {-1};
        table.addMouseMotionListener(new java.awt.event.MouseMotionAdapter() {
            @Override
            public void mouseMoved(java.awt.event.MouseEvent e) {
                int row = table.rowAtPoint(e.getPoint());
                if (row != hoverRow[0]) {
                    hoverRow[0] = row;
                    table.repaint();
                }
            }
        });
        table.addMouseListener(new java.awt.event.MouseAdapter() {
            @Override
            public void mouseExited(java.awt.event.MouseEvent e) {
                hoverRow[0] = -1;
                table.repaint();
            }
            @Override
            public void mouseClicked(java.awt.event.MouseEvent e) {
                int row = table.rowAtPoint(e.getPoint());
                if (row >= 0) table.setRowSelectionInterval(row, row);
            }
        });

        DefaultTableCellRenderer hoverRenderer = new DefaultTableCellRenderer() {
            @Override
            public Component getTableCellRendererComponent(JTable table, Object value, boolean isSelected, boolean hasFocus, int row, int column) {
                Component c = super.getTableCellRendererComponent(table, value, isSelected, hasFocus, row, column);
                if (!isSelected) {
                    c.setBackground(row == hoverRow[0] ? new Color(235, 245, 255) : Color.WHITE);
                }
                return c;
            }
        };
        // Aplica hover a todas as colunas exceto "Actions"
        for (int i = 0; i < table.getColumnCount(); i++) {
            if (!"Actions".equals(table.getColumnName(i))) {
                table.getColumnModel().getColumn(i).setCellRenderer(hoverRenderer);
            }
        }

        // ====== Configurar coluna "Actions" por NOME (não por índice fixo) ======
        setupActionsColumn(table, model, "Actions");

        // ====== RODAPÉ: Nome + (opcional) Sexo + Adicionar ======
        JPanel bottomControls = new JPanel();
        bottomControls.setLayout(new BoxLayout(bottomControls, BoxLayout.Y_AXIS));
        bottomControls.setOpaque(false);

        JPanel inputsLine = new JPanel(new FlowLayout(FlowLayout.LEFT, 6, 6));
        inputsLine.setOpaque(false);

        JLabel lblNome = new JLabel(labelText);
        tfNomeInput = new JTextField(20); // <--- agora é campo da classe

        JLabel lblSexo = new JLabel("Sexo:");
        cbSexo = new JComboBox<>(new String[]{"Masculino", "Feminino"});
        lblSexo.setVisible(isActor);
        cbSexo.setVisible(isActor);

        btnAdd = new JButton(btnText);

        inputsLine.add(lblNome);
        inputsLine.add(tfNomeInput);
        inputsLine.add(lblSexo);
        inputsLine.add(cbSexo);
        inputsLine.add(btnAdd);

        btnAdd.addActionListener(e -> {

            if (!tfNomeInput.getText().isEmpty()) {

                if (isActorGlobal) {
                    //actor

                    String nome = tfNomeInput.getText().trim();
                    String sexo = (String) cbSexo.getSelectedItem();

                    if(btnText == "Adicionar"){
                        cruDirAc.createActor(nome, sexo);
                    }
                    else{
                        cruDirAc.updateActor(idUpdate,nome, sexo);
                    }

                } else {
                    //director
                    String nome = tfNomeInput.getText().trim();

                    if(btnText == "Adicionar"){
                        cruDirAc.createDirector(nome);;
                    }
                    else{
                        cruDirAc.updateDirector(idUpdate,nome);
                    }

                }
            } else {
                // feedback visual no campo de nome (não no campo de filtro do topo)
                tfNomeInput.setBorder(BorderFactory.createLineBorder(Color.RED));
                // opcional: voltar ao padrão depois de 1s
                Timer t = new Timer(1200, ev -> tfNomeInput.setBorder(UIManager.getBorder("TextField.border")));
                t.setRepeats(false);
                t.start();
                return;
            }

            // Limpar campos após adicionar
            btnText = "Adicionar";
            btnAdd.setText(btnText);
            tfNomeInput.setText("");
            if (isActor) cbSexo.setSelectedIndex(0);

            //load data again
            //try {
                FilmeGUI fgui;
                if (isActorGlobal) {
                    //fgui = new FilmeGUI(true);
                }
                else{
                    //fgui = new FilmeGUI(false);
                }
            //} catch (SQLException ex) {
              //  throw new RuntimeException(ex);
            //}




            /*
                     // Scroll para a última linha e selecionar
            SwingUtilities.invokeLater(() -> {
                int viewRow = table.convertRowIndexToView(model.getRowCount() - 1);
                table.scrollRectToVisible(table.getCellRect(viewRow, 0, true));
                table.setRowSelectionInterval(viewRow, viewRow);
            });
             */
        });

        bottomControls.add(inputsLine);
        panel.add(bottomControls, BorderLayout.SOUTH);

        panel.revalidate();
        panel.repaint();
        return panel;
    }

    /**
     * Cria a JTable com modelo que só permite edição na coluna "Actions".
     */
    public JTable tabela(Object[][] dados, String[] cols) {
        model = new DefaultTableModel(dados, cols) {
            @Override
            public boolean isCellEditable(int row, int column) {
                // Apenas a coluna "Actions" é editável (para capturar cliques nos botões)
                return "Actions".equals(getColumnName(column));
            }
        };

        final JTable table = new JTable(model);
        table.setFillsViewportHeight(true);
        table.setRowHeight(36);
        table.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);
        table.getTableHeader().setFont(table.getTableHeader().getFont().deriveFont(Font.BOLD));

        // Scroll pane
        JScrollPane scroll = new JScrollPane(table);
        scroll.setVerticalScrollBarPolicy(JScrollPane.VERTICAL_SCROLLBAR_ALWAYS);

        // Centro com scroll
        JPanel center = new JPanel(new BorderLayout(6, 6));
        center.setOpaque(false);
        center.add(scroll, BorderLayout.CENTER);
        panel.add(center, BorderLayout.CENTER);

        return table;
    }

    /**
     * Garante que "Actions" exista nas colunas; se não existir, adiciona ao final.
     */
    private String[] ensureActionsColumn(String[] cols) {
        if (cols == null) {
            return new String[]{"Actions"};
        }
        boolean hasActions = Arrays.asList(cols).contains("Actions");
        if (hasActions) return cols;
        String[] out = Arrays.copyOf(cols, cols.length + 1);
        out[out.length - 1] = "Actions";
        return out;
    }

    /**
     * Garante que o array de dados possua uma célula extra por linha para "Actions".
     */
    private Object[][] ensureActionsData(Object[][] dados, String[] colsFinal) {
        if (dados == null || dados.length == 0) {
            return new Object[0][colsFinal.length];
        }
        int expectedCols = colsFinal.length;
        boolean needsExpand = dados[0].length < expectedCols;
        if (!needsExpand) return dados;

        Object[][] expanded = new Object[dados.length][expectedCols];
        for (int i = 0; i < dados.length; i++) {
            Object[] src = dados[i];
            Object[] dst = Arrays.copyOf(src, expectedCols);
            dst[expectedCols - 1] = null; // placeholder para Actions
            expanded[i] = dst;
        }
        return expanded;
    }

    /**
     * Encontra a coluna "Actions" por nome e aplica renderer/editor com botões ✎/✖,
     * além de definir largura adequada.
     */
    private void setupActionsColumn(JTable table, DefaultTableModel model, String actionsColName) {
        int actionsColIndex = -1;
        for (int i = 0; i < table.getColumnModel().getColumnCount(); i++) {
            if (Objects.equals(actionsColName, table.getColumnName(i))) {
                actionsColIndex = i;
                break;
            }
        }
        if (actionsColIndex < 0) return; // sem coluna "Actions"

        // --- Renderer ---
        class ActionsRenderer extends JPanel implements javax.swing.table.TableCellRenderer {
            private final JButton editBtn = new JButton("\u270E"); // ✎
            private final JButton delBtn = new JButton("\u2716");  // ✖
            ActionsRenderer() {
                setLayout(new FlowLayout(FlowLayout.CENTER, 6, 0));
                setOpaque(true);
                for (JButton b : new JButton[]{editBtn, delBtn}) {
                    b.setFocusable(false);
                    b.setBorderPainted(false);
                    b.setContentAreaFilled(false);
                    b.setOpaque(false);
                    b.setCursor(Cursor.getPredefinedCursor(Cursor.HAND_CURSOR));
                }
                editBtn.setToolTipText("Editar");
                delBtn.setToolTipText("Eliminar");
                add(editBtn);
                add(delBtn);
            }
            @Override
            public Component getTableCellRendererComponent(JTable table, Object value, boolean isSelected, boolean hasFocus, int row, int column) {
                setBackground(isSelected ? table.getSelectionBackground() : table.getBackground());
                return this;
            }
        }

        // --- Editor ---
        class ActionsEditor extends javax.swing.AbstractCellEditor implements javax.swing.table.TableCellEditor {
            private final JPanel editorPanel = new JPanel(new FlowLayout(FlowLayout.CENTER, 6, 0));
            private final JButton editBtn = new JButton("\u270E");
            private final JButton delBtn = new JButton("\u2716");
            private int editingRow = -1;

            ActionsEditor() {
                editorPanel.setOpaque(true);
                for (JButton b : new JButton[]{editBtn, delBtn}) {
                    b.setFocusable(false);
                    b.setBorderPainted(false);
                    b.setContentAreaFilled(false);
                    b.setOpaque(false);
                    b.setCursor(Cursor.getPredefinedCursor(Cursor.HAND_CURSOR));
                }
                editBtn.setToolTipText("Editar");
                delBtn.setToolTipText("Eliminar");
                editorPanel.add(editBtn);
                editorPanel.add(delBtn);

                // ===== CLIQUE EM EDITAR =====
                editBtn.addActionListener(e -> {
                    int modelRow = table.convertRowIndexToModel(editingRow);

                    // Colunas assumidas: 0 = ID, 1 = Nome, 2 = Sexo

                    Object nomeVal = model.getValueAt(modelRow, 1);

                    Object idVal = model.getValueAt(modelRow, 0);
                    idUpdate = Integer.parseInt(idVal.toString());

                    btnText = "Actualizar";
                    btnAdd.setText(btnText);

                    // Preencher campos conforme o tipo
                    if (isActorGlobal) {
                        // ATOR: preencher nome + sexo
                        Object sexoVal = (model.getColumnCount() > 2) ? model.getValueAt(modelRow, 2) : null;
                        tfNomeInput.setText(nomeVal.toString());

                        if (sexoVal != null) {
                            cbSexo.setSelectedItem(model.getValueAt(modelRow, 2).toString());
                        } else {
                            cbSexo.setSelectedIndex(-1);
                        }
                    } else {
                        // DIRETOR: apenas nome
                        tfNomeInput.setText(nomeVal != null ? nomeVal.toString() : "");
                        // não altera cbSexo
                    }

                    // Apenas carrega os campos; não salva no banco aqui.
                    fireEditingStopped();
                });

                // ===== CLIQUE EM EXCLUIR =====
                delBtn.addActionListener(e -> {
                    int modelRow = table.convertRowIndexToModel(editingRow);
                    Object val = model.getValueAt(modelRow, 0); // coluna 0 = ID
                    int id = (val instanceof Number) ? ((Number) val).intValue()
                            : (val != null ? Integer.parseInt(val.toString()) : -1);

                    int confirm = JOptionPane.showConfirmDialog(SwingUtilities.getWindowAncestor(panel),
                            "Eliminar registro ID " + id + "?", "Confirmar eliminação", JOptionPane.YES_NO_OPTION);

                    if (confirm == JOptionPane.YES_OPTION) {
                        if (isActorGlobal)
                            cruDirAc.deleteActor(id);
                        else
                            cruDirAc.deleteDirector(id);
                        model.removeRow(modelRow);
                    }
                    fireEditingStopped();
                });
            }

            @Override
            public Component getTableCellEditorComponent(JTable table, Object value, boolean isSelected, int row, int column) {
                this.editingRow = row;
                editorPanel.setBackground(table.getSelectionBackground());
                return editorPanel;
            }
            @Override
            public Object getCellEditorValue() { return null; }
        }

        TableColumn col = table.getColumnModel().getColumn(actionsColIndex);
        col.setCellRenderer(new ActionsRenderer());
        col.setCellEditor(new ActionsEditor());
        col.setPreferredWidth(140);
        col.setMinWidth(120);
        col.setMaxWidth(180);
    }


    private void hideColumnByModelIndex(JTable table, int modelColIndex) {
        // Converter índice do model para índice da view
        int viewIndex;
        try {
            viewIndex = table.convertColumnIndexToView(modelColIndex);
        } catch (IllegalArgumentException ex) {
            return; // coluna já pode ter sido removida da View
        }
        TableColumn col = table.getColumnModel().getColumn(viewIndex);
        table.getColumnModel().removeColumn(col);
    }

}
