package control;

import BDConnection.ConsultaRepositorio;

import javax.swing.*;
import java.awt.*;
import java.awt.event.ComponentAdapter;
import java.awt.event.ComponentEvent;
import java.sql.SQLException;
import java.util.Arrays;
import java.util.List;
import java.util.Map;
import java.util.ArrayList;

import static java.util.Arrays.copyOf;

public class FilmeGUI extends JFrame {

    private JPanel directoresPainel;
    private JPanel actorPainel;
    private JPanel estatisticaBottom;
    private JPanel content;
    private ConsultaRepositorio repositorio;
    private String[] cols;
    private Object[][] dados;
    private boolean startWithActor;

    public FilmeGUI(boolean startWithActor) throws SQLException {

        this.startWithActor = startWithActor;
        directoresPainel = new JPanel(new BorderLayout());
        actorPainel = new JPanel(new BorderLayout());
        estatisticaBottom = new JPanel(new BorderLayout());
        content = new JPanel(null);
        repositorio = new ConsultaRepositorio();
        String[] cols = new String [4];
        dados = null;

        iniApp();
        manageViews();
    }

    private void iniApp(){
        setTitle("CinemaMovies");
        setExtendedState(JFrame.MAXIMIZED_BOTH);
        setLayout(null);
        setLocationRelativeTo(null);
        setIconImage(new ImageIcon("").getImage());
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
    }

    private void manageViewsg(){

        setContentPane(content);

        // Painel superior (15% da altura)
        JPanel topPanel = new JPanel();
        topPanel.setLayout(new BorderLayout());
        topPanel.setBackground(new Color(220, 235, 255)); // azul claro
        content.add(topPanel);

        // Dentro do topPanel: label (linha 1) e painel de botões (linha 2)
        JLabel titleLabel = new JLabel("Tema da Tela", SwingConstants.CENTER);
        titleLabel.setFont(titleLabel.getFont().deriveFont(Font.BOLD, 20f));
        //topPanel.add(titleLabel, BorderLayout.NORTH);

        JPanel buttonsRow = new JPanel(new GridLayout(1, 3, 10, 0));
        buttonsRow.setOpaque(false);
        buttonsRow.setBorder(BorderFactory.createEmptyBorder(10, 20, 10, 20));
        buttonsRow.add(new JButton("Actores"));
        buttonsRow.add(new JButton("Directores"));
        buttonsRow.add(new JButton("Estatisiticas"));
        buttonsRow.setSize(850,25);
        topPanel.add(buttonsRow, BorderLayout.CENTER);


        // Painel inferior esquerdo (25% da largura do frame)
        JPanel leftBottom = new JPanel(new BorderLayout());
        leftBottom.setBackground(new Color(200, 255, 200)); // verde claro
        leftBottom.add(new JLabel("Área Esquerda (25%)", SwingConstants.CENTER), BorderLayout.CENTER);
        content.add(leftBottom);

        // Painel inferior direito (75% da largura do frame)
        JPanel rightBottom = new JPanel(new BorderLayout());
        rightBottom.setBackground(new Color(255, 230, 230)); // rosa claro
        rightBottom.add(new JLabel("Área Direita (75%)", SwingConstants.CENTER), BorderLayout.CENTER);
        content.add(rightBottom);

        // Função para posicionar os painéis com proporções fixas
        ComponentAdapter resizeHandler = new ComponentAdapter() {
            @Override
            public void componentResized(ComponentEvent e) {
                int w = content.getWidth();
                int h = content.getHeight();

                // Top = 15% da altura, Bottom = 85%
                int topH = (int) Math.round(h * 0.15);
                int bottomH = h - topH;

                // Bottom: left = 25% da largura, right = 75%
                int leftW = (int) Math.round(w * 0.4);
                int rightW = w - leftW;

                // definir bounds (x, y, largura, altura)
                topPanel.setBounds(0, 0, w, topH);

                leftBottom.setBounds(0, topH, leftW, bottomH);
                rightBottom.setBounds(leftW, topH, rightW, bottomH);
            }
        };

        // Adicionar listener ao frame/content para ajustar ao mostrar e redimensionar
        addComponentListener(resizeHandler);
        content.addComponentListener(resizeHandler);

        // Forçar posicionamento inicial antes de mostrar
        setVisible(true);
        // Chamar manualmente para garantir posições iniciais corretas
        resizeHandler.componentResized(null);

    }

    private void manageViews() throws SQLException {

            JPanel content = new JPanel(null);
            setContentPane(content);

            // Painel superior (15% da altura)
            JPanel topPanel = new JPanel();

            topPanel.add(botoesPanelMenu(), BorderLayout.CENTER);
            content.add(topPanel);

            jpanelActor();
            content.add(actorPainel);
            actorPainel.setVisible(startWithActor);

            jpanelDirector();
            content.add(directoresPainel);
            directoresPainel.setVisible(!startWithActor);

            jpanelEstatisticas();
            content.add(estatisticaBottom);
            estatisticaBottom.setVisible(false); // começa oculto

            // Função para posicionar os painéis com proporções fixas
           ComponentAdapter resizeHandler = new ComponentAdapter() {

                @Override
                public void componentResized(ComponentEvent e) {
                    int w = content.getWidth();
                    int h = content.getHeight();

                    // Top = 15% da altura, Bottom = 85%
                    int topH = (int) Math.round(h * 0.10);
                    int bottomH = h - topH;

                    // definir bounds (x, y, largura, altura)
                    topPanel.setBounds(0, 0, w, topH);
                    estatisticaBottom.setBounds(0, topH, w, bottomH);
                    actorPainel.setBounds(0, topH, w, bottomH);   // opcional: largura 0 quando oculto
                    directoresPainel.setBounds(0, topH, w, bottomH);
                }
            };

            // Adicionar listener ao frame/content para ajustar ao mostrar e redimensionar
            addComponentListener(resizeHandler);
            content.addComponentListener(resizeHandler);

            // Forçar posicionamento inicial antes de mostrar
            setVisible(true);
            // Chamar manualmente para garantir posições iniciais corretas
            resizeHandler.componentResized(null);//

    }


    private void jpanelDirector() throws SQLException {


        List<Map<String, Object>> rows = repositorio.listarTodosDirectores(20);

        // Extrai colunas
         cols = rows.get(0).keySet().toArray(new String[0]);

        // Converte para matriz
        dados = rows.stream()
                .map(row -> Arrays.stream(cols).map(row::get).toArray())
                .toArray(Object[][]::new);


        // Top: título + inputs
            JPanel top = new JPanel();
            top.setLayout(new BoxLayout(top, BoxLayout.Y_AXIS)); // empilha verticalmente
            top.setOpaque(false);

            top.add(titlePage("Tela de Directores"));

            directoresPainel.add(top, BorderLayout.NORTH);
            JTableFilmes tableFilmes = new JTableFilmes();


            directoresPainel.add(
                    tableFilmes.jtableGeneral(
                            dados,cols,fieldsDirAct("Nome do Director","Sexo"),
                            false, "Nome do director"
                    )
            );

    }

    private void jpanelActor() throws SQLException {

        List<Map<String, Object>> rows = repositorio.listarTodosActores(20);


        //Extrai as colunas existentes
        cols = rows.get(0).keySet().toArray(new String[0]);

        //Copia e adiciona mais uma posição
        cols= copyOf(cols, cols.length + 1);
        cols[cols.length - 1] = "Actions"; //


        // Converte para matriz
        dados = rows.stream()
                .map(row -> Arrays.stream(cols).map(row::get).toArray())
                .toArray(Object[][]::new);



        // Top: título + inputs
        JPanel top = new JPanel();
        top.setLayout(new BoxLayout(top, BoxLayout.Y_AXIS)); // empilha verticalmente
        top.setOpaque(false);


        top.add(titlePage("Tela de Actores"));

        actorPainel.add(top, BorderLayout.NORTH);
        JTableFilmes tableFilmes = new JTableFilmes();

        actorPainel.add(tableFilmes.jtableGeneral(dados,cols,fieldsDirAct("Nome do Actor","Sexo"),true, "Nome do Actor"));

    }

    private void jpanelEstatisticas(){
        Estatisticas est = new Estatisticas();
        estatisticaBottom.add(est.procViewTrigSelec());
        //return null;
    }

    private JPanel botoesPanelMenu(){

       // Linha 2: painel de botões alinhado à esquerda
        JPanel buttonsWrapper = new JPanel(new FlowLayout(FlowLayout.LEFT, 20, 10));
        buttonsWrapper.setOpaque(false);

        // Criar botões com tamanho fixo 350x45
        JButton btnActors = new JButton("Actores");
        JButton btnDirectors = new JButton("Directores");
        JButton btnStats = new JButton("Estatísticas");


        //buttons colors
        Color colorBack = new Color(16,110,190,50);
        Color colorClick = new Color(0,120,212);

        btnActors.setForeground(Color.white);
        btnDirectors.setForeground(Color.white);
        btnStats.setForeground(Color.white);

        btnActors.setBackground(colorClick);
        btnDirectors.setBackground(colorBack);
        btnStats.setBackground(colorBack);

        Dimension btnSize = new Dimension(350, 45);
        btnActors.setPreferredSize(btnSize);
        btnDirectors.setPreferredSize(btnSize);
        btnStats.setPreferredSize(btnSize);

        btnActors.setFocusable(false);
        btnDirectors.setFocusable(false);
        btnStats.setFocusable(false);

        buttonsWrapper.add(btnActors);
        buttonsWrapper.add(btnDirectors);
        buttonsWrapper.add(btnStats);

        // Ações dos botões: mostrar/ocultar panels
        btnStats.addActionListener(e -> {
            // esconder left/right e mostrar estatistica
            actorPainel.setVisible(false);
            directoresPainel.setVisible(false);
            estatisticaBottom.setVisible(true);
            content.revalidate();
            content.repaint();

            btnActors.setBackground(colorBack);
            btnDirectors.setBackground(colorBack);
            btnStats.setBackground(colorClick);


        });

        btnActors.addActionListener(e -> {
            // mostrar left/right e esconder estatistica
            estatisticaBottom.setVisible(false);
            actorPainel.setVisible(true);
            directoresPainel.setVisible(false);
            content.revalidate();
            content.repaint();

            btnActors.setBackground(colorClick);
            btnDirectors.setBackground(colorBack);
            btnStats.setBackground(colorBack);
        });

        btnDirectors.addActionListener(e -> {
            // mostrar left/right e esconder estatistica
            estatisticaBottom.setVisible(false);
            actorPainel.setVisible(false);
            directoresPainel.setVisible(true);
            content.revalidate();
            content.repaint();

            btnActors.setBackground(colorBack);
            btnDirectors.setBackground(colorClick);
            btnStats.setBackground(colorBack);
        });

        return buttonsWrapper;
    }


    // campos para cada Entidade
    private JPanel fieldsDirAct(String field1text, String field2text){

        JPanel inputs = new JPanel(new FlowLayout(FlowLayout.LEFT, 8, 6));
        inputs.setOpaque(false);

        inputs.add(new JLabel(field1text));
        JTextField tfName = new JTextField(25);
        inputs.add(tfName);

        inputs.add(new JLabel(field2text));
        JTextField tfGender = new JTextField(25);
        inputs.add(tfGender);

        return inputs;
    }

    //titulo de cada pag
    private JPanel titlePage(String titleScreen){

        JPanel title = new JPanel(new FlowLayout(FlowLayout.LEFT, 8, 6));
        JLabel lblTitle = new JLabel(titleScreen,SwingConstants.LEFT); // sem SwingConstants.CENTER
        lblTitle.setFont(lblTitle.getFont().deriveFont(Font.BOLD, 18f));
        lblTitle.setBorder(javax.swing.BorderFactory.createEmptyBorder(4, 4, 4, 4));
        lblTitle.setAlignmentX(Component.LEFT_ALIGNMENT);
        title.add(lblTitle);

        return title;
    }

}
